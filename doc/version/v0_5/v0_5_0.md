# v0.5.0：Heap 架構 

<br>

---

<br>


**目標**：建立統一的堆記憶體管理架構

**設計要點**：

```
JVM Heap 結構：

┌───────────────────────────────────────────────────────┐
│                      JVM Heap                         │
├───────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────┐  │
│  │              Young Generation                   │  │
│  │  ┌────────────┬──────────┬──────────┐          │  │
│  │  │   Eden     │Survivor 0│Survivor 1│          │  │
│  │  │            │  (From)  │  (To)    │          │  │
│  │  └────────────┴──────────┴──────────┘          │  │
│  └─────────────────────────────────────────────────┘  │
│  ┌─────────────────────────────────────────────────┐  │
│  │              Old Generation                     │  │
│  │                                                 │  │
│  │                                                 │  │
│  └─────────────────────────────────────────────────┘  │
└───────────────────────────────────────────────────────┘
```

<br>

**記憶體分配器設計**：

```go
// runtime/heap/allocator.go

type Heap struct {
    youngGen *YoungGeneration
    oldGen   *OldGeneration
    
    // 統計資訊
    totalAllocated int64
    totalFreed     int64
    gcCount        int
}

type YoungGeneration struct {
    eden      []byte
    survivor0 []byte
    survivor1 []byte
    
    edenTop   int  // Eden 區的分配指針
}

// 快速分配（Bump Pointer）
func (y *YoungGeneration) Allocate(size int) *Object {
    if y.edenTop + size > len(y.eden) {
        return nil  // 觸發 Minor GC
    }
    
    addr := y.edenTop
    y.edenTop += size
    return (*Object)(unsafe.Pointer(&y.eden[addr]))
}
```

<br>

**GC Roots 枚舉**：

```go
// runtime/heap/gc_roots.go

func EnumerateGCRoots() []*Object {
    var roots []*Object
    
    // 1. 所有執行緒的 JVM Stack
    for _, thread := range allThreads {
        for frame := thread.TopFrame(); frame != nil; frame = frame.Lower() {
            // LocalVars 中的引用
            for i := 0; i < frame.LocalVars().Size(); i++ {
                if ref := frame.LocalVars().GetRef(i); ref != nil {
                    roots = append(roots, ref)
                }
            }
            // OperandStack 中的引用
            // ...
        }
    }
    
    // 2. 靜態變數
    for _, class := range loadedClasses {
        for _, ref := range class.StaticRefs() {
            if ref != nil {
                roots = append(roots, ref)
            }
        }
    }
    
    // 3. 字串常量池
    for _, str := range internedStrings {
        roots = append(roots, str)
    }
    
    return roots
}
```

<br>