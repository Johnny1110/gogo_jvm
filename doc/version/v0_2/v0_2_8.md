# v0.2.8：類型系統增強 - `instanceof` / `checkcast` / `anewarray`

<br>

---

<br>

**目標**：完善物件類型系統，支援類型檢查與引用類型陣列

**需要實現的指令**：

| 指令 | Opcode | 功能 |
|------|--------|------|
| `instanceof` | `0xC1` | 判斷物件是否為指定類型的實例 |
| `checkcast` | `0xC0` | 類型強制轉換（失敗拋 ClassCastException） |
| `anewarray` | `0xBD` | 建立引用類型陣列（如 `String[]`） |

<br>

**設計要點**：

`instanceof` 的判斷邏輯：

```
obj instanceof T 的判斷規則：
1. 如果 obj 是 null → 返回 false
2. 如果 obj.class == T → 返回 true
3. 如果 T 是 class → 檢查 obj.class 的繼承鏈是否包含 T
4. 如果 T 是 interface → 檢查 obj.class 是否實現了 T
5. 如果 T 是陣列類型 → 特殊處理
```

<br>

`checkcast` 與 `instanceof` 的差異：

```
instanceof: 返回 boolean（true/false）
checkcast:  成功則不做任何事，失敗則拋出 ClassCastException
```

<br>

`anewarray` 與 `newarray` 的差異：

```
newarray:   建立基本類型陣列（int[], byte[], ...）
anewarray:  建立引用類型陣列（String[], Object[], ...）
```

<br>

**需要完善的模組**：

```go
// runtime/method_area/class.go
// 新增方法：

// IsAssignableFrom 判斷 this 是否是 other 的父類或介面
func (c *Class) IsAssignableFrom(other *Class) bool

// IsSubClassOf 判斷 this 是否是 target 的子類
func (c *Class) IsSubClassOf(target *Class) bool

// IsImplements 判斷 this 是否實現了 iface 介面
func (c *Class) IsImplements(iface *Class) bool
```

<br>

**測試目標**：

```java
public class TestInstanceof {
    public static void main(String[] args) {
        Object obj = new String();
        
        if (obj instanceof String) {
            System.out.println(1);  // 應輸出 1
        }
        
        String s = (String) obj;    // checkcast 成功
        
        String[] arr = new String[5];
        arr[0] = "Hello";
        System.out.println(arr.length);  // 應輸出 5
    }
}
```

<br>