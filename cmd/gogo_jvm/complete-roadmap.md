

---

<br>

### Phase v0.2.9ï¼šå­—ä¸²æ”¯æ´ âŒ› (è¨ˆåŠƒä¸­)

**ç›®æ¨™**ï¼šå¯¦ç¾å®Œæ•´çš„ `java.lang.String` æ”¯æ´

**è¨­è¨ˆè¦é»**ï¼š

```
String åœ¨ JVM ä¸­çš„çµæ§‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ String Object                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ class â†’ java/lang/String            â”‚
â”‚ fields:                             â”‚
â”‚   value â†’ char[] (å­˜æ”¾å­—å…ƒ)          â”‚
â”‚   hash  â†’ int (hash code å¿«å–)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

<br>

**éœ€è¦å¯¦ç¾çš„åŠŸèƒ½**ï¼š

| åŠŸèƒ½ | èªªæ˜ |
|------|------|
| String ç‰©ä»¶çµæ§‹ | æ¨¡æ“¬ `java.lang.String` é¡ |
| å­—ä¸²é§ç•™ (String Interning) | ç›¸åŒå­—ä¸²å…±ç”¨åŒä¸€ç‰©ä»¶ |
| `ldc` è¼‰å…¥å­—ä¸² | å¾å¸¸é‡æ± è¼‰å…¥å­—ä¸²å¸¸é‡ |
| `println(String)` | å®Œæ•´çš„å­—ä¸²è¼¸å‡ºæ”¯æ´ |

<br>

**å­—ä¸²é§ç•™æ©Ÿåˆ¶**ï¼š

```go
// runtime/heap/string_pool.go

var internedStrings = map[string]*Object{}

// InternString å­—ä¸²é§ç•™
// ç›¸åŒå…§å®¹çš„å­—ä¸²è¿”å›åŒä¸€å€‹ Object
func InternString(goStr string) *Object {
    if obj, ok := internedStrings[goStr]; ok {
        return obj
    }
    
    // å‰µå»ºæ–°çš„ String ç‰©ä»¶
    chars := stringToUtf16(goStr)
    obj := NewStringObject(chars)
    internedStrings[goStr] = obj
    return obj
}
```

<br>

**æ¸¬è©¦ç›®æ¨™**ï¼š

```java
public class TestString {
    public static void main(String[] args) {
        String s1 = "Hello";
        String s2 = "World";
        System.out.println(s1);       // è¼¸å‡º: Hello
        System.out.println(s2);       // è¼¸å‡º: World
        System.out.println("Done");   // è¼¸å‡º: Done
    }
}
```

<br>

---

<br>

### Phase v0.2.10ï¼šç•°å¸¸è™•ç† âŒ› (è¨ˆåŠƒä¸­)

**ç›®æ¨™**ï¼šå¯¦ç¾ try-catch-finally ç•°å¸¸è™•ç†æ©Ÿåˆ¶

**éœ€è¦å¯¦ç¾çš„æŒ‡ä»¤**ï¼š

| æŒ‡ä»¤ | Opcode | åŠŸèƒ½ |
|------|--------|------|
| `athrow` | `0xBF` | æ‹‹å‡ºç•°å¸¸ |

<br>

**è¨­è¨ˆè¦é»**ï¼š

ç•°å¸¸è¡¨çµæ§‹ï¼ˆæ¯å€‹æ–¹æ³•çš„ Code å±¬æ€§ä¸­ï¼‰ï¼š

```
Exception Table Entry:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ start_pc  â”‚ end_pc  â”‚handler_pcâ”‚ catch_type â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ try é–‹å§‹  â”‚ try çµæŸâ”‚catch å…¥å£â”‚ æ•ç²çš„ç•°å¸¸é¡â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

catch_type = 0 è¡¨ç¤º finallyï¼ˆæ•ç²æ‰€æœ‰ç•°å¸¸ï¼‰
```

<br>

**ç•°å¸¸è™•ç†æµç¨‹**ï¼š

```
athrow åŸ·è¡Œæ™‚ï¼š
1. å¾æ£§é ‚å–å¾—ç•°å¸¸ç‰©ä»¶
2. åœ¨ç•¶å‰æ–¹æ³•çš„ç•°å¸¸è¡¨ä¸­æŸ¥æ‰¾åŒ¹é…çš„ handler
3. å¦‚æœæ‰¾åˆ° â†’ è·³è½‰åˆ° handler_pc ç¹¼çºŒåŸ·è¡Œ
4. å¦‚æœæ‰¾ä¸åˆ° â†’ å½ˆå‡ºç•¶å‰ Frameï¼Œåœ¨èª¿ç”¨è€…ä¸­ç¹¼çºŒæŸ¥æ‰¾
5. å¦‚æœæ£§ç©ºäº†é‚„æ²’æ‰¾åˆ° â†’ ç·šç¨‹çµ‚æ­¢ï¼Œæ‰“å°ç•°å¸¸ä¿¡æ¯
```

<br>

**æ£§å±•é–‹ (Stack Unwinding)**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ methodC     â”‚ â† ç•°å¸¸ç™¼ç”Ÿé»ï¼Œæ‰¾ä¸åˆ° handler
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ methodB     â”‚ â† ç¹¼çºŒæŸ¥æ‰¾ï¼Œæ‰¾ä¸åˆ° handler  
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ methodA     â”‚ â† æ‰¾åˆ° handlerï¼è·³è½‰åˆ° catch å¡Š
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ main        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

<br>

**éœ€è¦è§£æçš„å±¬æ€§**ï¼š

```go
// classfile/attr_code.go
type ExceptionTableEntry struct {
    StartPc   uint16  // try å¡Šé–‹å§‹ä½ç½®
    EndPc     uint16  // try å¡ŠçµæŸä½ç½®
    HandlerPc uint16  // catch è™•ç†å™¨å…¥å£
    CatchType uint16  // æ•ç²çš„ç•°å¸¸é¡å‹ï¼ˆå¸¸é‡æ± ç´¢å¼•ï¼Œ0=finallyï¼‰
}
```

<br>

**æ¸¬è©¦ç›®æ¨™**ï¼š

```java
public class TestException {
    public static void main(String[] args) {
        try {
            int x = 1 / 0;
        } catch (ArithmeticException e) {
            System.out.println(1);  // æ‡‰è¼¸å‡º 1
        }
        
        try {
            throwIt();
        } catch (RuntimeException e) {
            System.out.println(2);  // æ‡‰è¼¸å‡º 2
        }
        
        System.out.println(3);      // æ‡‰è¼¸å‡º 3
    }
    
    public static void throwIt() {
        throw new RuntimeException();
    }
}
```

<br>

---

<br>

### Phase v0.2.11ï¼šä»‹é¢æ”¯æ´ âŒ› (è¨ˆåŠƒä¸­)

**ç›®æ¨™**ï¼šæ”¯æ´ Java ä»‹é¢çš„å®šç¾©èˆ‡èª¿ç”¨

**éœ€è¦å¯¦ç¾çš„æŒ‡ä»¤**ï¼š

| æŒ‡ä»¤ | Opcode | åŠŸèƒ½ |
|------|--------|------|
| `invokeinterface` | `0xB9` | èª¿ç”¨ä»‹é¢æ–¹æ³• |

<br>

**è¨­è¨ˆè¦é»**ï¼š

`invokeinterface` vs `invokevirtual` çš„å·®ç•°ï¼š

```
invokevirtual:
  - ç”¨æ–¼èª¿ç”¨é¡çš„å¯¦ä¾‹æ–¹æ³•
  - å¯ä»¥åˆ©ç”¨ vtableï¼ˆæ–¹æ³•åœ¨å›ºå®šåç§»é‡ï¼‰å„ªåŒ–

invokeinterface:
  - ç”¨æ–¼èª¿ç”¨ä»‹é¢æ–¹æ³•
  - ç„¡æ³•ä½¿ç”¨ vtableï¼ˆå› ç‚ºé¡å¯ä»¥å¯¦ç¾å¤šå€‹ä»‹é¢ï¼‰
  - éœ€è¦åœ¨é‹è¡Œæ™‚æœç´¢æ–¹æ³•
```

<br>

**ä»‹é¢æ–¹æ³•æŸ¥æ‰¾æµç¨‹**ï¼š

```
invokeinterface Runnable.run()V
    â”‚
    â”œâ”€ 1. å¾æ£§å–å¾— objectref
    â”œâ”€ 2. å–å¾— objectref çš„å¯¦éš›é¡å‹ C
    â”œâ”€ 3. åœ¨ C ä¸­æŸ¥æ‰¾ run()V
    â”‚     â”œâ”€ C æœ‰æ­¤æ–¹æ³•ï¼Ÿâ†’ èª¿ç”¨
    â”‚     â””â”€ C æ²’æœ‰ï¼Ÿâ†’ å¾€çˆ¶é¡æŸ¥æ‰¾
    â””â”€ 4. æ‰¾ä¸åˆ° â†’ AbstractMethodError
```

<br>

**invokeinterface çš„ç‰¹æ®Šæ ¼å¼**ï¼š

```
invokeinterface çš„æ“ä½œæ•¸æ¯”è¼ƒç‰¹æ®Šï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ invokeinterface indexbyte1 indexbyte2 count 0â”‚
â”‚               (2 bytes)            (1) (1)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

count: åƒæ•¸ä½”ç”¨çš„ slot æ•¸ + 1ï¼ˆåŒ…å« thisï¼‰
æœ€å¾Œä¸€å€‹ 0: æ­·å²éºç•™ï¼Œå¿…é ˆç‚º 0
```

<br>

**éœ€è¦å®Œå–„çš„æ¨¡çµ„**ï¼š

```go
// runtime/method_area/class.go

// æ¨™è¨˜é¡æ˜¯å¦ç‚ºä»‹é¢
func (c *Class) IsInterface() bool {
    return c.accessFlags & ACC_INTERFACE != 0
}

// å–å¾—é¡å¯¦ç¾çš„æ‰€æœ‰ä»‹é¢
func (c *Class) Interfaces() []*Class

// åœ¨é¡åŠå…¶çˆ¶é¡ä¸­æŸ¥æ‰¾ä»‹é¢æ–¹æ³•çš„å¯¦ç¾
func (c *Class) LookupInterfaceMethod(name, descriptor string) *Method
```

<br>

**æ¸¬è©¦ç›®æ¨™**ï¼š

```java
interface Greeting {
    void sayHello();
}

class EnglishGreeting implements Greeting {
    public void sayHello() {
        System.out.println(1);  // ä»£è¡¨ "Hello"
    }
}

class ChineseGreeting implements Greeting {
    public void sayHello() {
        System.out.println(2);  // ä»£è¡¨ "ä½ å¥½"
    }
}

public class TestInterface {
    public static void main(String[] args) {
        Greeting g1 = new EnglishGreeting();
        Greeting g2 = new ChineseGreeting();
        
        g1.sayHello();  // invokeinterface â†’ è¼¸å‡º 1
        g2.sayHello();  // invokeinterface â†’ è¼¸å‡º 2
    }
}
```

<br>

---

<br>

## ğŸ v0.2.x é‡Œç¨‹ç¢‘

å®Œæˆ v0.2.11 å¾Œï¼ŒGOGO JVM å°‡èƒ½åŸ·è¡Œå¤§éƒ¨åˆ†**å–®åŸ·è¡Œç·’ç´” Java ç¨‹å¼**ï¼š

- âœ… å®Œæ•´çš„é¡å‹ç³»çµ±ï¼ˆé¡ã€ä»‹é¢ã€é™£åˆ—ï¼‰
- âœ… å®Œæ•´çš„æ–¹æ³•èª¿ç”¨ï¼ˆstaticã€specialã€virtualã€interfaceï¼‰
- âœ… ç•°å¸¸è™•ç†æ©Ÿåˆ¶
- âœ… å­—ä¸²æ”¯æ´
- âœ… åŸºæœ¬çš„ Native Method æ¡†æ¶

<br>

---

<br>

## Phase v0.3.xï¼šç‰©ä»¶æ¨¡å‹å®Œå–„ï¼ˆGC / å¤šåŸ·è¡Œç·’ å…±åŒå‰ç½®ï¼‰

<br>

### Phase v0.3.0ï¼šåå°„åŸºç¤ âŒ› (è¨ˆåŠƒä¸­)

**ç›®æ¨™**ï¼šå¯¦ç¾ `java.lang.Class` ç‰©ä»¶èˆ‡åŸºæœ¬åå°„åŠŸèƒ½

**è¨­è¨ˆè¦é»**ï¼š

```
æ¯å€‹é¡åˆ¥åœ¨ JVM ä¸­éƒ½æœ‰å°æ‡‰çš„ Class ç‰©ä»¶ï¼š

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ String å¯¦ä¾‹      â”‚         â”‚ Integer å¯¦ä¾‹    â”‚
  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚         â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
  â”‚ â”‚class pointerâ”‚â”€â”¼â”€â”€â”€â”€â”    â”‚ â”‚class pointerâ”‚â”€â”¼â”€â”€â”€â”€â”
  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
                         â–¼                           â–¼
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚ Class<String>â”‚            â”‚Class<Integer>â”‚
                 â”‚ (Class ç‰©ä»¶) â”‚            â”‚ (Class ç‰©ä»¶) â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

<br>

**éœ€è¦å¯¦ç¾çš„åŠŸèƒ½**ï¼š

| åŠŸèƒ½ | èªªæ˜ |
|------|------|
| `Object.getClass()` | å–å¾—ç‰©ä»¶çš„ Class |
| `Class.forName()` | æ ¹æ“šåç¨±è¼‰å…¥é¡åˆ¥ |
| `Class.getName()` | å–å¾—é¡åˆ¥åç¨± |
| `Class.getSuperclass()` | å–å¾—çˆ¶é¡ |
| `Class.getInterfaces()` | å–å¾—å¯¦ç¾çš„ä»‹é¢ |
| `Class.newInstance()` | åå°„å‰µå»ºå¯¦ä¾‹ |

<br>

**æ¸¬è©¦ç›®æ¨™**ï¼š

```java
public class TestReflection {
    public static void main(String[] args) {
        Object obj = new String();
        Class<?> clazz = obj.getClass();
        System.out.println(clazz.getName());  // java.lang.String
    }
}
```

<br>

---

<br>

### Phase v0.3.1ï¼šç‰©ä»¶é ­é‡æ§‹ âŒ› (è¨ˆåŠƒä¸­)

**ç›®æ¨™**ï¼šå¯¦ç¾æ¨™æº–çš„ç‰©ä»¶é ­ï¼ˆObject Headerï¼‰ï¼Œç‚ºå¤šåŸ·è¡Œç·’å’Œ GC æ‰“åŸºç¤

**è¨­è¨ˆè¦é»**ï¼š

```
ç‰©ä»¶é ­çµæ§‹ï¼ˆMark Wordï¼‰- 64 ä½å…ƒç³»çµ±ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Mark Word (64 bits)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ unused  â”‚ hashCode  â”‚  age   â”‚ biased  â”‚   lock state     â”‚
â”‚ (25 bit)â”‚ (31 bit)  â”‚(4 bit) â”‚ (1 bit) â”‚    (3 bit)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚            â”‚         â”‚            â”‚
           â”‚            â”‚         â”‚            â””â”€ é–ç‹€æ…‹ï¼ˆå¤šåŸ·è¡Œç·’ç”¨ï¼‰
           â”‚            â”‚         â””â”€ åå‘é–æ¨™è¨˜ï¼ˆå¤šåŸ·è¡Œç·’ç”¨ï¼‰
           â”‚            â””â”€ GC å¹´é½¡ï¼ˆGC ç”¨ï¼‰
           â””â”€ ç‰©ä»¶ hashCodeï¼ˆObject.hashCode ç”¨ï¼‰

Lock State:
  001 = ç„¡é–
  101 = åå‘é–
  00  = è¼•é‡ç´šé–
  10  = é‡é‡ç´šé–
  11  = GC æ¨™è¨˜
```

<br>

**éœ€è¦ä¿®æ”¹çš„æ¨¡çµ„**ï¼š

```go
// runtime/heap/object.go

type Object struct {
    markWord uint64        // æ–°å¢ï¼šç‰©ä»¶é ­
    class    *Class        // é¡å‹æŒ‡æ¨™
    fields   Slots         // å¯¦ä¾‹æ¬„ä½
    extra    interface{}   // é¡å¤–è³‡æ–™ï¼ˆé™£åˆ—å…ƒç´ ç­‰ï¼‰
}

// Mark Word æ“ä½œ
func (o *Object) HashCode() int32
func (o *Object) SetHashCode(hash int32)
func (o *Object) GCAge() uint8
func (o *Object) IncrementAge()
func (o *Object) LockState() uint8
func (o *Object) SetLockState(state uint8)
```

<br>

---

<br>

### Phase v0.3.2ï¼šReference é¡å‹ âŒ› (è¨ˆåŠƒä¸­)

**ç›®æ¨™**ï¼šå¯¦ç¾ `java.lang.ref` å¥—ä»¶ä¸­çš„å¼•ç”¨é¡å‹

**è¨­è¨ˆè¦é»**ï¼š

```
å››ç¨®å¼•ç”¨å¼·åº¦ï¼ˆå¾å¼·åˆ°å¼±ï¼‰ï¼š

Strong Referenceï¼ˆå¼·å¼•ç”¨ï¼‰
    â”‚  Object obj = new Object();
    â”‚  åªè¦å¼·å¼•ç”¨å­˜åœ¨ï¼Œç‰©ä»¶ä¸æœƒè¢«å›æ”¶
    â–¼
Soft Referenceï¼ˆè»Ÿå¼•ç”¨ï¼‰
    â”‚  SoftReference<Object> ref = new SoftReference<>(obj);
    â”‚  è¨˜æ†¶é«”ä¸è¶³æ™‚æ‰æœƒè¢«å›æ”¶
    â–¼
Weak Referenceï¼ˆå¼±å¼•ç”¨ï¼‰
    â”‚  WeakReference<Object> ref = new WeakReference<>(obj);
    â”‚  ä¸‹æ¬¡ GC æ™‚å°±æœƒè¢«å›æ”¶
    â–¼
Phantom Referenceï¼ˆè™›å¼•ç”¨ï¼‰
       PhantomReference<Object> ref = new PhantomReference<>(obj, queue);
       ç„¡æ³•é€šéè™›å¼•ç”¨å–å¾—ç‰©ä»¶ï¼Œåƒ…ç”¨æ–¼è¿½è¹¤ç‰©ä»¶è¢«å›æ”¶çš„æ™‚æ©Ÿ
```

<br>

**éœ€è¦å¯¦ç¾çš„é¡åˆ¥**ï¼š

| é¡åˆ¥ | åŠŸèƒ½ |
|------|------|
| `Reference<T>` | å¼•ç”¨åŸºé¡ |
| `SoftReference<T>` | è»Ÿå¼•ç”¨ |
| `WeakReference<T>` | å¼±å¼•ç”¨ |
| `PhantomReference<T>` | è™›å¼•ç”¨ |
| `ReferenceQueue<T>` | å¼•ç”¨ä½‡åˆ— |

<br>

---

<br>

### Phase v0.3.3ï¼šObject ç”Ÿå‘½é€±æœŸ âŒ› (è¨ˆåŠƒä¸­)

**ç›®æ¨™**ï¼šå®Œå–„ç‰©ä»¶å¾å‰µå»ºåˆ°å›æ”¶çš„å®Œæ•´ç”Ÿå‘½é€±æœŸ

**éœ€è¦å¯¦ç¾çš„åŠŸèƒ½**ï¼š

| åŠŸèƒ½ | èªªæ˜ |
|------|------|
| `Object.hashCode()` | ç‰©ä»¶é›œæ¹Šç¢¼ï¼ˆåˆ©ç”¨ Mark Wordï¼‰ |
| `Object.equals()` | é è¨­çš„ç›¸ç­‰æ¯”è¼ƒ |
| `Object.clone()` | ç‰©ä»¶è¤‡è£½ |
| `Object.finalize()` | ç‰©ä»¶çµ‚çµæ–¹æ³•ï¼ˆGC å‰å‘¼å«ï¼‰ |

<br>

**finalize çš„ç‰¹æ®Šè™•ç†**ï¼š

```
ç‰©ä»¶å›æ”¶æµç¨‹ï¼ˆæœ‰ finalize æ™‚ï¼‰ï¼š

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     GC ç™¼ç¾      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ æ´»è‘—çš„   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚ ä¸å¯é”ä½†æœ‰   â”‚
  â”‚ ç‰©ä»¶    â”‚   ç‰©ä»¶ä¸å¯é”     â”‚ finalize    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                     æ”¾å…¥ Finalization Queue
                                      â”‚
                                      â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ Finalizer   â”‚
                              â”‚ åŸ·è¡Œç·’å‘¼å«   â”‚
                              â”‚ finalize()  â”‚
                              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                      â”‚                      â”‚
              â–¼                      â–¼                      â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ å¾©æ´»ï¼ˆåˆè¢«   â”‚        â”‚ æ­£å¸¸çµæŸ    â”‚        â”‚ æ‹‹å‡ºç•°å¸¸    â”‚
      â”‚ å¼•ç”¨äº†ï¼‰    â”‚        â”‚ ä¸‹æ¬¡ GC å›æ”¶â”‚        â”‚ å¿½ç•¥ï¼Œç¹¼çºŒ  â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

<br>

---

<br>

## ğŸ v0.3.x é‡Œç¨‹ç¢‘

å®Œæˆ v0.3.3 å¾Œï¼Œç‰©ä»¶æ¨¡å‹å®Œå‚™ï¼š

- âœ… Class ç‰©ä»¶èˆ‡åŸºæœ¬åå°„
- âœ… æ¨™æº–ç‰©ä»¶é ­ï¼ˆMark Wordï¼‰
- âœ… Reference é¡å‹æ”¯æ´
- âœ… å®Œæ•´çš„ç‰©ä»¶ç”Ÿå‘½é€±æœŸ

**å¯ä»¥é–‹å§‹å¯¦ç¾å¤šåŸ·è¡Œç·’å’Œ GCï¼**

<br>

---

<br>

## Phase v0.4.xï¼šå¤šåŸ·è¡Œç·’

<br>

### Phase v0.4.0ï¼šThread åŸºç¤ âŒ› (è¨ˆåŠƒä¸­)

**ç›®æ¨™**ï¼šå¯¦ç¾ `java.lang.Thread` é¡èˆ‡åŸºæœ¬åŸ·è¡Œç·’ç®¡ç†

**è¨­è¨ˆè¦é»**ï¼š

```
Java Thread èˆ‡åº•å±¤å¯¦ç¾çš„æ˜ å°„ï¼š

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Java Thread     â”‚
  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ â”‚ run()       â”‚ â”‚         â”‚ Go goroutine    â”‚
  â”‚ â”‚ start()     â”‚â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ (è¼•é‡ç´šåŸ·è¡Œç·’)   â”‚
  â”‚ â”‚ join()      â”‚ â”‚         â”‚                 â”‚
  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  å„ªé»ï¼šåˆ©ç”¨ Go çš„ goroutine èª¿åº¦å™¨
  ç¼ºé»ï¼šèˆ‡çœŸå¯¦ JVM çš„åŸ·è¡Œç·’æ¨¡å‹ç•¥æœ‰å·®ç•°
```

<br>

**éœ€è¦å¯¦ç¾çš„åŠŸèƒ½**ï¼š

| æ–¹æ³• | èªªæ˜ |
|------|------|
| `Thread.start()` | å•Ÿå‹•åŸ·è¡Œç·’ |
| `Thread.run()` | åŸ·è¡Œç·’åŸ·è¡Œé«” |
| `Thread.join()` | ç­‰å¾…åŸ·è¡Œç·’çµæŸ |
| `Thread.sleep(long)` | åŸ·è¡Œç·’ä¼‘çœ  |
| `Thread.yield()` | è®“å‡º CPU |
| `Thread.currentThread()` | å–å¾—ç•¶å‰åŸ·è¡Œç·’ |

<br>

**åŸ·è¡Œç·’ç‹€æ…‹æ©Ÿ**ï¼š

```
         start()
  NEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º RUNNABLE â—„â”€â”€â”€â”€â”€â”
                         â”‚          â”‚
                         â”‚ wait()   â”‚ notify()
                         â–¼          â”‚
                      WAITING â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ timeout
                         â–¼
                   TIMED_WAITING
                         â”‚
         run() çµæŸ      â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â–¼
       TERMINATED
```

<br>

**æ¸¬è©¦ç›®æ¨™**ï¼š

```java
public class TestThread {
    public static void main(String[] args) {
        Thread t = new Thread(() -> {
            System.out.println(1);  // å­åŸ·è¡Œç·’è¼¸å‡º
        });
        t.start();
        t.join();
        System.out.println(2);      // ä¸»åŸ·è¡Œç·’è¼¸å‡º
    }
}
```

<br>

---

<br>

### Phase v0.4.1ï¼šsynchronized åŒæ­¥ âŒ› (è¨ˆåŠƒä¸­)

**ç›®æ¨™**ï¼šå¯¦ç¾ `synchronized` é—œéµå­—èˆ‡ Monitor æ©Ÿåˆ¶

**éœ€è¦å¯¦ç¾çš„æŒ‡ä»¤**ï¼š

| æŒ‡ä»¤ | Opcode | åŠŸèƒ½ |
|------|--------|------|
| `monitorenter` | `0xC2` | é€²å…¥åŒæ­¥å€å¡Šï¼ˆå–å¾—é–ï¼‰ |
| `monitorexit` | `0xC3` | é›¢é–‹åŒæ­¥å€å¡Šï¼ˆé‡‹æ”¾é–ï¼‰ |

<br>

**Monitor çµæ§‹**ï¼š

```
æ¯å€‹ç‰©ä»¶éƒ½æœ‰ä¸€å€‹é—œè¯çš„ Monitorï¼š

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚             Monitor                 â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ owner: Thread         (é–çš„æ“æœ‰è€…)  â”‚
  â”‚ entryCount: int       (é‡å…¥æ¬¡æ•¸)    â”‚
  â”‚ waitSet: Set<Thread>  (ç­‰å¾…é›†åˆ)    â”‚
  â”‚ entryList: List<Thread>(é˜»å¡ä½‡åˆ—)   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  synchronized(obj) {
      // monitorenter: å˜—è©¦å–å¾— obj çš„ Monitor
      //               æˆåŠŸ â†’ owner = currentThread
      //               å¤±æ•— â†’ åŠ å…¥ entryList ç­‰å¾…
      
      // ... è‡¨ç•Œå€ ...
      
      // monitorexit: é‡‹æ”¾ Monitor
      //              entryCount--
      //              å¦‚æœ entryCount == 0ï¼Œå–šé†’ entryList ä¸­çš„åŸ·è¡Œç·’
  }
```

<br>

**æ¸¬è©¦ç›®æ¨™**ï¼š

```java
public class TestSynchronized {
    static int counter = 0;
    static Object lock = new Object();
    
    public static void main(String[] args) {
        Thread t1 = new Thread(() -> {
            for (int i = 0; i < 1000; i++) {
                synchronized (lock) {
                    counter++;
                }
            }
        });
        
        Thread t2 = new Thread(() -> {
            for (int i = 0; i < 1000; i++) {
                synchronized (lock) {
                    counter++;
                }
            }
        });
        
        t1.start();
        t2.start();
        t1.join();
        t2.join();
        
        System.out.println(counter);  // æ‡‰è©²è¼¸å‡º 2000
    }
}
```

<br>

---

<br>

### Phase v0.4.2ï¼šwait / notify æ©Ÿåˆ¶ âŒ› (è¨ˆåŠƒä¸­)

**ç›®æ¨™**ï¼šå¯¦ç¾åŸ·è¡Œç·’é–“çš„å”èª¿é€šè¨Š

**éœ€è¦å¯¦ç¾çš„æ–¹æ³•**ï¼š

| æ–¹æ³• | èªªæ˜ |
|------|------|
| `Object.wait()` | é‡‹æ”¾é–ä¸¦ç­‰å¾… |
| `Object.wait(long)` | å¸¶è¶…æ™‚çš„ç­‰å¾… |
| `Object.notify()` | å–šé†’ä¸€å€‹ç­‰å¾…çš„åŸ·è¡Œç·’ |
| `Object.notifyAll()` | å–šé†’æ‰€æœ‰ç­‰å¾…çš„åŸ·è¡Œç·’ |

<br>

**wait / notify æµç¨‹**ï¼š

```
  Thread A                          Thread B
     â”‚                                 â”‚
     â”‚ synchronized(obj)               â”‚
     â–¼                                 â”‚
  å–å¾— Monitor                         â”‚
     â”‚                                 â”‚
     â”‚ obj.wait()                      â”‚
     â–¼                                 â”‚
  é‡‹æ”¾ Monitor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚ synchronized(obj)
  é€²å…¥ Wait Set                        â–¼
     â”‚                              å–å¾— Monitor
     â”‚                                 â”‚
     â”‚                                 â”‚ obj.notify()
     â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  è¢«å–šé†’ï¼Œç§»åˆ° Entry List              â”‚
     â”‚                                 â”‚ é›¢é–‹ synchronized
     â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ é‡‹æ”¾ Monitor
  é‡æ–°å–å¾— Monitor                     â”‚
     â”‚                                 â”‚
     â–¼                                 â”‚
  å¾ wait() è¿”å›                       â”‚
```

<br>

**æ¸¬è©¦ç›®æ¨™**ï¼š

```java
public class TestWaitNotify {
    static Object lock = new Object();
    static boolean ready = false;
    
    public static void main(String[] args) {
        Thread consumer = new Thread(() -> {
            synchronized (lock) {
                while (!ready) {
                    lock.wait();
                }
                System.out.println(2);  // è¢«å–šé†’å¾Œè¼¸å‡º
            }
        });
        
        Thread producer = new Thread(() -> {
            synchronized (lock) {
                ready = true;
                System.out.println(1);  // å…ˆè¼¸å‡º
                lock.notify();
            }
        });
        
        consumer.start();
        Thread.sleep(100);  // ç¢ºä¿ consumer å…ˆåŸ·è¡Œ
        producer.start();
        
        // é æœŸè¼¸å‡º: 1, 2
    }
}
```

<br>

---

<br>

### Phase v0.4.3ï¼šåŸ·è¡Œç·’ä¸­æ–·èˆ‡é€²éšæ§åˆ¶ âŒ› (è¨ˆåŠƒä¸­)

**ç›®æ¨™**ï¼šå¯¦ç¾åŸ·è¡Œç·’ä¸­æ–·æ©Ÿåˆ¶èˆ‡é€²éšç®¡ç†

**éœ€è¦å¯¦ç¾çš„åŠŸèƒ½**ï¼š

| æ–¹æ³• | èªªæ˜ |
|------|------|
| `Thread.interrupt()` | ä¸­æ–·åŸ·è¡Œç·’ |
| `Thread.isInterrupted()` | æª¢æŸ¥ä¸­æ–·ç‹€æ…‹ |
| `Thread.interrupted()` | æª¢æŸ¥ä¸¦æ¸…é™¤ä¸­æ–·ç‹€æ…‹ |
| `InterruptedException` | ä¸­æ–·ç•°å¸¸ |

<br>

---

<br>

### Phase v0.4.4ï¼švolatile èˆ‡è¨˜æ†¶é«”æ¨¡å‹ âŒ› (è¨ˆåŠƒä¸­)

**ç›®æ¨™**ï¼šå¯¦ç¾ `volatile` èªç¾©èˆ‡åŸºæœ¬çš„è¨˜æ†¶é«”å¯è¦‹æ€§

**è¨­è¨ˆè¦é»**ï¼š

```
volatile çš„å…©å€‹èªç¾©ï¼š

1. å¯è¦‹æ€§ï¼šä¸€å€‹åŸ·è¡Œç·’ä¿®æ”¹ volatile è®Šæ•¸å¾Œï¼Œå…¶ä»–åŸ·è¡Œç·’ç«‹å³å¯è¦‹

2. ç¦æ­¢é‡æ’åºï¼švolatile è®€å¯«å‰å¾Œçš„æ“ä½œä¸èƒ½é‡æ’åº

Happens-Before è¦å‰‡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å° volatile è®Šæ•¸çš„å¯«å…¥ happens-before å¾ŒçºŒå°è©²è®Šæ•¸çš„è®€å– â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

<br>

**éœ€è¦è™•ç†çš„æƒ…æ³**ï¼š

```go
// runtime/method_area/field.go
func (f *Field) IsVolatile() bool {
    return f.accessFlags & ACC_VOLATILE != 0
}

// å° volatile æ¬„ä½çš„è®€å¯«éœ€è¦ï¼š
// 1. ä½¿ç”¨ atomic æ“ä½œ
// 2. æ’å…¥é©ç•¶çš„è¨˜æ†¶é«”å±éšœ
```

<br>

---

<br>

### Phase v0.4.5ï¼šSafe Point æ©Ÿåˆ¶ âŒ› (è¨ˆåŠƒä¸­)

**ç›®æ¨™**ï¼šå¯¦ç¾å®‰å…¨é»æ©Ÿåˆ¶ï¼Œç‚º GC çš„ Stop-The-World åšæº–å‚™

**è¨­è¨ˆè¦é»**ï¼š

```
Safe Pointï¼ˆå®‰å…¨é»ï¼‰ï¼š
åŸ·è¡Œç·’å¯ä»¥å®‰å…¨æš«åœçš„ä½ç½®ï¼Œæ­¤æ™‚ï¼š
- æ‰€æœ‰ GC Roots éƒ½å¯ä»¥è¢«æ­£ç¢ºè­˜åˆ¥
- ç‰©ä»¶å¼•ç”¨é—œä¿‚ç©©å®š

å¸¸è¦‹çš„ Safe Point ä½ç½®ï¼š
â”œâ”€â”€ æ–¹æ³•å‘¼å«/è¿”å›
â”œâ”€â”€ è¿´åœˆå›é‚Šï¼ˆback edgeï¼‰
â”œâ”€â”€ ç•°å¸¸æ‹‹å‡º
â””â”€â”€ JNI å‘¼å«å‰å¾Œ
```

<br>

**Stop-The-World æµç¨‹**ï¼š

```
  GC Thread                    Application Threads
      â”‚                              â”‚ â”‚ â”‚
      â”‚ ç™¼èµ· STW è«‹æ±‚               â”‚ â”‚ â”‚
      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚ â”‚ â”‚
      â”‚                              â”‚ â”‚ â”‚
      â”‚                    åˆ°é” Safe Point
      â”‚                              â— â— â—
      â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
      â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
      â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”‚ æ‰€æœ‰åŸ·è¡Œç·’å·²æš«åœ
      â–¼
   åŸ·è¡Œ GC
      â”‚
      â”‚ æ¢å¾©åŸ·è¡Œ
      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚ â”‚ â”‚
      â”‚                              â”‚ â”‚ â”‚
```

<br>

---

<br>

## ğŸ v0.4.x é‡Œç¨‹ç¢‘

å®Œæˆ v0.4.5 å¾Œï¼Œå¤šåŸ·è¡Œç·’åŠŸèƒ½å®Œå‚™ï¼š

- âœ… Thread é¡èˆ‡åŸºæœ¬åŸ·è¡Œç·’ç®¡ç†
- âœ… synchronized åŒæ­¥æ©Ÿåˆ¶
- âœ… wait / notify åŸ·è¡Œç·’å”èª¿
- âœ… åŸ·è¡Œç·’ä¸­æ–·
- âœ… volatile è¨˜æ†¶é«”å¯è¦‹æ€§
- âœ… Safe Pointï¼ˆGC å¿…éœ€ï¼‰

**å¯ä»¥é–‹å§‹å°ˆæ³¨æ–¼ GC ç ”ç©¶ï¼**

<br>

---

<br>

## Phase v0.5.xï¼šğŸ¯ GC å°ˆé¡Œç ”ç©¶ï¼ˆæœ€çµ‚ç›®æ¨™ï¼‰

<br>

### Phase v0.5.0ï¼šHeap æ¶æ§‹ âŒ› (è¨ˆåŠƒä¸­)

**ç›®æ¨™**ï¼šå»ºç«‹çµ±ä¸€çš„å †è¨˜æ†¶é«”ç®¡ç†æ¶æ§‹

**è¨­è¨ˆè¦é»**ï¼š

```
JVM Heap çµæ§‹ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      JVM Heap                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              Young Generation                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚  â”‚
â”‚  â”‚  â”‚   Eden     â”‚Survivor 0â”‚Survivor 1â”‚          â”‚  â”‚
â”‚  â”‚  â”‚            â”‚  (From)  â”‚  (To)    â”‚          â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              Old Generation                     â”‚  â”‚
â”‚  â”‚                                                 â”‚  â”‚
â”‚  â”‚                                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

<br>

**è¨˜æ†¶é«”åˆ†é…å™¨è¨­è¨ˆ**ï¼š

```go
// runtime/heap/allocator.go

type Heap struct {
    youngGen *YoungGeneration
    oldGen   *OldGeneration
    
    // çµ±è¨ˆè³‡è¨Š
    totalAllocated int64
    totalFreed     int64
    gcCount        int
}

type YoungGeneration struct {
    eden      []byte
    survivor0 []byte
    survivor1 []byte
    
    edenTop   int  // Eden å€çš„åˆ†é…æŒ‡é‡
}

// å¿«é€Ÿåˆ†é…ï¼ˆBump Pointerï¼‰
func (y *YoungGeneration) Allocate(size int) *Object {
    if y.edenTop + size > len(y.eden) {
        return nil  // è§¸ç™¼ Minor GC
    }
    
    addr := y.edenTop
    y.edenTop += size
    return (*Object)(unsafe.Pointer(&y.eden[addr]))
}
```

<br>

**GC Roots æšèˆ‰**ï¼š

```go
// runtime/heap/gc_roots.go

func EnumerateGCRoots() []*Object {
    var roots []*Object
    
    // 1. æ‰€æœ‰åŸ·è¡Œç·’çš„ JVM Stack
    for _, thread := range allThreads {
        for frame := thread.TopFrame(); frame != nil; frame = frame.Lower() {
            // LocalVars ä¸­çš„å¼•ç”¨
            for i := 0; i < frame.LocalVars().Size(); i++ {
                if ref := frame.LocalVars().GetRef(i); ref != nil {
                    roots = append(roots, ref)
                }
            }
            // OperandStack ä¸­çš„å¼•ç”¨
            // ...
        }
    }
    
    // 2. éœæ…‹è®Šæ•¸
    for _, class := range loadedClasses {
        for _, ref := range class.StaticRefs() {
            if ref != nil {
                roots = append(roots, ref)
            }
        }
    }
    
    // 3. å­—ä¸²å¸¸é‡æ± 
    for _, str := range internedStrings {
        roots = append(roots, str)
    }
    
    return roots
}
```

<br>

---

<br>

### Phase v0.5.1ï¼šMark-Sweep GC âŒ› (è¨ˆåŠƒä¸­)

**ç›®æ¨™**ï¼šå¯¦ç¾æœ€åŸºæœ¬çš„æ¨™è¨˜-æ¸…é™¤åƒåœ¾å›æ”¶å™¨

**ä¸‰è‰²æ¨™è¨˜æ³•**ï¼š

```
ä¸‰è‰²æŠ½è±¡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç™½è‰²ï¼šå°šæœªè¨ªå•çš„ç‰©ä»¶ï¼ˆGC çµæŸå¾Œï¼Œç™½è‰²ç‰©ä»¶å°‡è¢«å›æ”¶ï¼‰      â”‚
â”‚ ç°è‰²ï¼šå·²è¨ªå•ä½†å…¶å¼•ç”¨å°šæœªæƒæçš„ç‰©ä»¶                      â”‚
â”‚ é»‘è‰²ï¼šå·²è¨ªå•ä¸”å…¶æ‰€æœ‰å¼•ç”¨éƒ½å·²æƒæçš„ç‰©ä»¶ï¼ˆç¢ºå®šå­˜æ´»ï¼‰       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ¨™è¨˜éç¨‹ï¼š
1. åˆå§‹æ™‚ï¼Œæ‰€æœ‰ç‰©ä»¶éƒ½æ˜¯ç™½è‰²
2. å°‡ GC Roots ç›´æ¥å¼•ç”¨çš„ç‰©ä»¶æ¨™è¨˜ç‚ºç°è‰²
3. å¾ç°è‰²ç‰©ä»¶ä¸­å–å‡ºä¸€å€‹ï¼š
   a. å°‡å…¶æ‰€æœ‰å¼•ç”¨çš„ç™½è‰²ç‰©ä»¶æ¨™è¨˜ç‚ºç°è‰²
   b. å°‡è©²ç‰©ä»¶æ¨™è¨˜ç‚ºé»‘è‰²
4. é‡è¤‡æ­¥é©Ÿ 3ï¼Œç›´åˆ°æ²’æœ‰ç°è‰²ç‰©ä»¶
5. æ­¤æ™‚ï¼Œç™½è‰²ç‰©ä»¶å³ç‚ºåƒåœ¾
```

<br>

**å¯¦ç¾ä»£ç¢¼æ¡†æ¶**ï¼š

```go
// runtime/gc/mark_sweep.go

type MarkSweepGC struct {
    heap      *Heap
    white     map[*Object]bool  // æœªæ¨™è¨˜
    gray      []*Object          // å¾…è™•ç†ä½‡åˆ—
    black     map[*Object]bool  // å·²æ¨™è¨˜
}

func (gc *MarkSweepGC) Mark() {
    // 1. åˆå§‹åŒ–ï¼šæ‰€æœ‰ç‰©ä»¶éƒ½æ˜¯ç™½è‰²
    gc.white = gc.heap.AllObjects()
    gc.gray = []*Object{}
    gc.black = make(map[*Object]bool)
    
    // 2. å°‡ GC Roots åŠ å…¥ç°è‰²ä½‡åˆ—
    for _, root := range EnumerateGCRoots() {
        gc.markGray(root)
    }
    
    // 3. è™•ç†ç°è‰²ç‰©ä»¶
    for len(gc.gray) > 0 {
        obj := gc.gray[len(gc.gray)-1]
        gc.gray = gc.gray[:len(gc.gray)-1]
        
        gc.scanObject(obj)
        gc.black[obj] = true
    }
}

func (gc *MarkSweepGC) Sweep() {
    // å›æ”¶æ‰€æœ‰ç™½è‰²ç‰©ä»¶
    for obj := range gc.white {
        gc.heap.Free(obj)
    }
}
```

<br>

**è¨˜æ†¶é«”ç¢ç‰‡å•é¡Œ**ï¼š

```
Mark-Sweep å¾Œçš„è¨˜æ†¶é«”ç‹€æ…‹ï¼š

  â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”
  â”‚ A â”‚   â”‚ B â”‚   â”‚   â”‚ C â”‚   â”‚ D â”‚   â”‚   â”‚
  â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜
        â†‘       â†‘   â†‘       â†‘       â†‘   â†‘
        ç©ºé–’     ç©ºé–’ç¢ç‰‡     ç©ºé–’     ç©ºé–’ç¢ç‰‡

å•é¡Œï¼šé›–ç„¶ç¸½ç©ºé–’ç©ºé–“è¶³å¤ ï¼Œä½†ç„¡æ³•åˆ†é…å¤§ç‰©ä»¶
è§£æ±ºï¼šMark-Compactï¼ˆå£“ç¸®ï¼‰
```

<br>

---

<br>

### Phase v0.5.2ï¼šMark-Compact GC âŒ› (è¨ˆåŠƒä¸­)

**ç›®æ¨™**ï¼šå¯¦ç¾æ¨™è¨˜-å£“ç¸®åƒåœ¾å›æ”¶å™¨ï¼Œè§£æ±ºè¨˜æ†¶é«”ç¢ç‰‡å•é¡Œ

**å£“ç¸®æ¼”ç®—æ³•ï¼ˆLisp2 é¢¨æ ¼ï¼‰**ï¼š

```
å£“ç¸®éç¨‹ï¼ˆä¸‰æ¬¡éæ­·ï¼‰ï¼š

ç¬¬ä¸€æ¬¡éæ­·ï¼šè¨ˆç®—æ–°åœ°å€
  â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”
  â”‚ A â”‚   â”‚ B â”‚   â”‚   â”‚ C â”‚   â”‚ D â”‚   â”‚   â”‚
  â””â”€â”¬â”€â”´â”€â”€â”€â”´â”€â”¬â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”¬â”€â”´â”€â”€â”€â”´â”€â”¬â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜
    â”‚       â”‚           â”‚       â”‚
    â”‚       â”‚           â”‚       â””â”€â–º æ–°åœ°å€: 3
    â”‚       â”‚           â””â”€â–º æ–°åœ°å€: 2
    â”‚       â””â”€â–º æ–°åœ°å€: 1
    â””â”€â–º æ–°åœ°å€: 0

ç¬¬äºŒæ¬¡éæ­·ï¼šæ›´æ–°æ‰€æœ‰å¼•ç”¨
  å°‡æ‰€æœ‰æŒ‡å‘ A, B, C, D çš„å¼•ç”¨æ›´æ–°ç‚ºæ–°åœ°å€

ç¬¬ä¸‰æ¬¡éæ­·ï¼šç§»å‹•ç‰©ä»¶
  â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ A â”‚ B â”‚ C â”‚ D â”‚       Free            â”‚
  â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

<br>

---

<br>

### Phase v0.5.3ï¼šCopying GC âŒ› (è¨ˆåŠƒä¸­)

**ç›®æ¨™**ï¼šå¯¦ç¾è¤‡è£½å¼åƒåœ¾å›æ”¶å™¨ï¼Œé©ç”¨æ–¼ Young Generation

**Semi-Space è¨­è¨ˆ**ï¼š

```
Copying GCï¼ˆCheney æ¼”ç®—æ³•ï¼‰ï¼š

GC å‰ï¼š
  From Space              To Space
  â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ A â”‚ B â”‚ C â”‚ D â”‚ E â”‚  â”‚   (ç©ºçš„)       â”‚
  â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†‘       â†‘
  å­˜æ´»    åƒåœ¾

GC å¾Œï¼š
  From Space (ç¾åœ¨æ˜¯ To)   To Space (ç¾åœ¨æ˜¯ From)
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   (ç©ºçš„)       â”‚       â”‚ A â”‚ C â”‚ Free  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜
                            åªè¤‡è£½å­˜æ´»ç‰©ä»¶

å„ªé»ï¼š
- æ²’æœ‰ç¢ç‰‡
- åˆ†é…é€Ÿåº¦å¿«ï¼ˆBump Pointerï¼‰
- é©åˆå­˜æ´»ç‡ä½çš„å ´æ™¯ï¼ˆYoung Generationï¼‰

ç¼ºé»ï¼š
- è¨˜æ†¶é«”åˆ©ç”¨ç‡åªæœ‰ 50%
- å­˜æ´»ç‰©ä»¶å¤šæ™‚æ•ˆç‡ä½
```

<br>

---

<br>

### Phase v0.5.4ï¼šåˆ†ä»£ GC âŒ› (è¨ˆåŠƒä¸­)

**ç›®æ¨™**ï¼šå¯¦ç¾åˆ†ä»£åƒåœ¾å›æ”¶ï¼Œçµåˆ Copying GC å’Œ Mark-Compact

**åˆ†ä»£å‡èªª**ï¼š

```
åˆ†ä»£å‡èªªï¼ˆGenerational Hypothesisï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¤§å¤šæ•¸ç‰©ä»¶åœ¨å‰µå»ºå¾Œå¾ˆå¿«å°±æœƒæ­»äº¡ï¼ˆæœç”Ÿå¤•æ»…ï¼‰                 â”‚
â”‚ ç†¬éå¤šæ¬¡ GC çš„ç‰©ä»¶ï¼Œå¾€å¾€èƒ½ç¹¼çºŒå­˜æ´»å¾ˆé•·æ™‚é–“                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åŸºæ–¼æ­¤å‡èªªçš„åˆ†ä»£ç­–ç•¥ï¼š
- Young Genï¼šä½¿ç”¨ Copying GCï¼ˆå¤§å¤šæ•¸ç‰©ä»¶æœƒæ­»ï¼‰
- Old Genï¼šä½¿ç”¨ Mark-Compactï¼ˆç‰©ä»¶å­˜æ´»ç‡é«˜ï¼‰
```

<br>

**GC è§¸ç™¼èˆ‡æ™‰å‡**ï¼š

```
Minor GCï¼ˆYoung Gen GCï¼‰ï¼š
1. ç•¶ Eden å€æ»¿æ™‚è§¸ç™¼
2. è¤‡è£½ Eden + From Survivor ä¸­çš„å­˜æ´»ç‰©ä»¶åˆ° To Survivor
3. å­˜æ´»è¶…éé–¾å€¼ï¼ˆå¦‚ 15 æ¬¡ï¼‰çš„ç‰©ä»¶æ™‰å‡åˆ° Old Gen
4. äº¤æ› From å’Œ To

Major GC / Full GCï¼ˆOld Gen GCï¼‰ï¼š
1. ç•¶ Old Gen ç©ºé–“ä¸è¶³æ™‚è§¸ç™¼
2. å° Old Gen é€²è¡Œ Mark-Compact
3. é€šå¸¸æœƒé †å¸¶åšä¸€æ¬¡ Minor GC

ç‰©ä»¶æ™‰å‡ï¼š
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                     â”‚
  â”‚  Eden â”€â”€â”¬â”€â”€â–º Survivor â”€â”€â”¬â”€â”€â–º Survivor â”€â”€â–º Old Gen  â”‚
  â”‚         â”‚               â”‚                          â”‚
  â”‚         â”‚   age++       â”‚   age >= 15              â”‚
  â”‚         â”‚               â”‚                          â”‚
  â”‚         â””â”€â”€â”€â–º æ­»äº¡      â””â”€â”€â”€â–º æ­»äº¡                  â”‚
  â”‚                                                     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

<br>

**è·¨ä»£å¼•ç”¨è™•ç†ï¼ˆRemember Setï¼‰**ï¼š

```
å•é¡Œï¼šMinor GC æ™‚ï¼Œå¦‚ä½•çŸ¥é“ Old Gen å¼•ç”¨äº†å“ªäº› Young Gen ç‰©ä»¶ï¼Ÿ

  Old Gen              Young Gen
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚     A     â”‚â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚     X     â”‚  â† é€™å€‹å¼•ç”¨æ€éº¼è¾¦ï¼Ÿ
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è§£æ±ºï¼šRemember Setï¼ˆæˆ– Card Tableï¼‰

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Card Tableï¼šå°‡ Old Gen åŠƒåˆ†ç‚º 512 byte çš„ Card      â”‚
  â”‚ æ¯å€‹ Card æœ‰ä¸€å€‹æ¨™è¨˜ä½                              â”‚
  â”‚ ç•¶ Old Gen ç‰©ä»¶å¼•ç”¨ Young Gen æ™‚ï¼Œæ¨™è¨˜å°æ‡‰ Card     â”‚
  â”‚ Minor GC æ™‚ï¼Œåªæƒæè¢«æ¨™è¨˜çš„ Card                    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

<br>

---

<br>

### Phase v0.5.5ï¼šä½µç™¼ GC åŸºç¤ âŒ› (è¨ˆåŠƒä¸­)

**ç›®æ¨™**ï¼šå¯¦ç¾ä½µç™¼æ¨™è¨˜ï¼Œæ¸›å°‘ Stop-The-World æ™‚é–“

**ä½µç™¼æ¨™è¨˜çš„æŒ‘æˆ°**ï¼š

```
å•é¡Œï¼šæ¨™è¨˜éç¨‹ä¸­ï¼Œæ‡‰ç”¨åŸ·è¡Œç·’ä¿®æ”¹äº†å¼•ç”¨é—œä¿‚

  GC Thread              Application Thread
      â”‚                         â”‚
      â”‚ æ¨™è¨˜ A ç‚ºé»‘è‰²           â”‚
      â”‚ (A çš„æ‰€æœ‰å¼•ç”¨å·²æƒæ)    â”‚
      â”‚                         â”‚
      â”‚                         â”‚ A.field = C  (æ–°å¼•ç”¨)
      â”‚                         â”‚ B.field = null (åˆªé™¤åŸå¼•ç”¨)
      â”‚                         â”‚
      â”‚ æƒæ B                   â”‚
      â”‚ (æ²’ç™¼ç¾ C)               â”‚
      â”‚                         â”‚
      â–¼                         â–¼
    C è¢«èª¤èªç‚ºåƒåœ¾ï¼éŒ¯èª¤å›æ”¶ï¼
```

<br>

**è§£æ±ºæ–¹æ¡ˆï¼šå¯«å±éšœï¼ˆWrite Barrierï¼‰**ï¼š

```
å…©ç¨®ç­–ç•¥ï¼š

1. SATBï¼ˆSnapshot-At-The-Beginningï¼‰- G1 ä½¿ç”¨
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ åœ¨ GC é–‹å§‹æ™‚ï¼Œè¨˜éŒ„å¼•ç”¨é—œä¿‚çš„å¿«ç…§                     â”‚
   â”‚ å¯«å±éšœï¼šè¨˜éŒ„è¢«åˆªé™¤çš„å¼•ç”¨ï¼ˆB.field = null æ™‚è¨˜éŒ„ Cï¼‰  â”‚
   â”‚ ç¢ºä¿å¿«ç…§ä¸­å¯é”çš„ç‰©ä»¶ä¸æœƒè¢«èª¤å›æ”¶                    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

2. Incremental Update - CMS ä½¿ç”¨
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ å¯«å±éšœï¼šè¨˜éŒ„æ–°å¢çš„å¼•ç”¨ï¼ˆA.field = C æ™‚æ¨™è¨˜ A ç‚ºç°è‰²ï¼‰â”‚
   â”‚ éœ€è¦é‡æ–°æƒæè¢«ä¿®æ”¹çš„é»‘è‰²ç‰©ä»¶                        â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

<br>

**å¯¦ç¾æ¡†æ¶**ï¼š

```go
// runtime/gc/write_barrier.go

// SATB å¯«å±éšœ
func SATBWriteBarrier(slot *Object, oldValue *Object) {
    if gcPhase == MARKING && oldValue != nil {
        // è¨˜éŒ„è¢«è¦†è“‹çš„å¼•ç”¨
        satbQueue.Push(oldValue)
    }
}

// æ¬„ä½å¯«å…¥æ™‚èª¿ç”¨
func (o *Object) SetField(index int, value *Object) {
    oldValue := o.fields[index]
    SATBWriteBarrier(&o.fields[index], oldValue)
    o.fields[index] = value
}
```

<br>

---

<br>

### Phase v0.5.6ï¼šé€²éš GCï¼ˆå¯é¸ç ”ç©¶æ–¹å‘ï¼‰âŒ› (è¨ˆåŠƒä¸­)

**ç›®æ¨™**ï¼šç ”ç©¶ç¾ä»£ GC æ¼”ç®—æ³•çš„è¨­è¨ˆæ€æƒ³

**G1 GC æ¦‚å¿µ**ï¼š

```
G1 çš„ Region åŠƒåˆ†ï¼š

â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”
â”‚  E  â”‚  E  â”‚  S  â”‚  O  â”‚  O  â”‚  H  â”‚  H  â”‚  -  â”‚
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜
   E = Eden
   S = Survivor
   O = Old
   H = Humongous (å¤§ç‰©ä»¶)
   - = ç©ºé–’

ç‰¹é»ï¼š
- å°‡ Heap åŠƒåˆ†ç‚ºç­‰å¤§çš„ Regionï¼ˆ1-32 MBï¼‰
- Region å¯ä»¥å‹•æ…‹å……ç•¶ Eden/Survivor/Old
- Garbage Firstï¼šå„ªå…ˆå›æ”¶åƒåœ¾æœ€å¤šçš„ Region
- å¯é æ¸¬çš„åœé “æ™‚é–“
```

<br>

**ZGC / Shenandoah æ¦‚å¿µ**ï¼š

```
Colored Pointerï¼ˆæŸ“è‰²æŒ‡é‡ï¼‰ï¼š

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚           64-bit ç‰©ä»¶æŒ‡é‡                              â”‚
  â”œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ 16 â”‚  1  â”‚  1  â”‚  1  â”‚            45                   â”‚
  â”‚bitsâ”‚ bit â”‚ bit â”‚ bit â”‚          bits                   â”‚
  â”œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚unusedâ”‚ Finalizable â”‚ Remapped â”‚ Marked1 â”‚ Marked0 â”‚åœ°å€â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å„ªé»ï¼š
- å¯ä»¥åœ¨ä¸ä¿®æ”¹ç‰©ä»¶çš„æƒ…æ³ä¸‹è¨˜éŒ„ GC ç‹€æ…‹
- é…åˆ Load Barrier å¯¦ç¾ä½µç™¼å£“ç¸®
- åœé “æ™‚é–“å¯æ§åˆ¶åœ¨ 10ms ä»¥å…§
```

<br>

---

<br>

## ğŸ† æœ€çµ‚é‡Œç¨‹ç¢‘

å®Œæˆ v0.5.x å¾Œï¼Œä½ å°‡ï¼š

- âœ… æ·±å…¥ç†è§£å„ç¨® GC æ¼”ç®—æ³•çš„è¨­è¨ˆæ€æƒ³
- âœ… è¦ªæ‰‹å¯¦ç¾ Mark-Sweepã€Mark-Compactã€Copyingã€Generational GC
- âœ… ç†è§£ä½µç™¼ GC çš„æŒ‘æˆ°èˆ‡è§£æ±ºæ–¹æ¡ˆ
- âœ… å…·å‚™è¨­è¨ˆæ–° GC æ¼”ç®—æ³•çš„èƒ½åŠ›
- âœ… ç‚ºè¨­è¨ˆè‡ªå·±çš„ç¨‹å¼èªè¨€æ‰“ä¸‹å …å¯¦åŸºç¤

<br>

---

<br>

## ç¸½è¦½ï¼šç‰ˆæœ¬è¦åŠƒ

| å¤§ç‰ˆæœ¬ | ä¸»é¡Œ | å­ç‰ˆæœ¬æ•¸ | ç›®æ¨™ |
|--------|------|----------|------|
| v0.1.x | ClassFile è§£æ | 1 | âœ… å·²å®Œæˆ |
| v0.2.x | æ ¸å¿ƒåŸ·è¡Œå¼•æ“ | 11 | å–®åŸ·è¡Œç·’ Java ç¨‹å¼å®Œæ•´åŸ·è¡Œ |
| v0.3.x | ç‰©ä»¶æ¨¡å‹å®Œå–„ | 4 | GC/å¤šåŸ·è¡Œç·’ å…±åŒå‰ç½® |
| v0.4.x | å¤šåŸ·è¡Œç·’ | 6 | ä½µç™¼ç¨‹å¼æ”¯æ´ + Safe Point |
| v0.5.x | ğŸ¯ GC å°ˆé¡Œ | 7 | æ·±å…¥ç ”ç©¶å„ç¨® GC æ¼”ç®—æ³• |

<br>

```
é–‹ç™¼é€²åº¦è¦–è¦ºåŒ–ï¼š

v0.1.x â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% âœ…
v0.2.x â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  50% âŒ› (ç›®å‰åœ¨é€™è£¡)
v0.3.x â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   0%
v0.4.x â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   0%
v0.5.x â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   0% ğŸ¯ æœ€çµ‚ç›®æ¨™
```

<br>

---

<br>